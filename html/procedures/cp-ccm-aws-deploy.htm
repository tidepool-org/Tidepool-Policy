<h3>Automated change management for deploys to AWS</h3>
<p>The Tidepool Continuous Delivery Pipeline automates creation and
validation of change requests. This is done in a 3-step process:</p>
<ol>
<li>
<p><strong>Create/Validate Change Request Ticket</strong></p>
<p>circle-ci.org is used for continuous delivery (build and deploy), and we employ
circle-ci.org-https://tidepool.atlassian.net automation such that:</p>
<ul>
<li>Whenever deployment to a controlled environment (e.g. production accounts
and infrastructure account) is requested, the circle-ci.org job will check for
an approved PRODCM ticket, or create a new ticket if not found.</li>
<li>The automation code will attempt to automatically populate the required
data for the PRODCM ticket (see list above).</li>
<li>If the data cannot be automatically populated, circle-ci.org may pause the job
and prompt the user for manual input.</li>
<li>Job will be paused until the request is approved or canceled (rejected).
Before continuing to deployment, circle-ci.org will validate the change
request's build job identifier, build number and source code branch.</li>
</ul>
</li>
<li>
<p><strong>Detect Change Details and Obtain Approval</strong></p>
<p>A separate <code>change-management-bot</code> is implemented to provide additional
details to assist/automate the ticket approval process:</p>
<ul>
<li>
<p>Whenever a PRODCM ticket is created, the bot is triggered via a https://tidepool.atlassian.net webhook.</p>
</li>
<li>
<p>The bot is configured to examine the following:</p>
<ul>
<li>Look for all the code changes since the last approved PRODCM ticket.</li>
<li>Check that all code commits have been approved by a reviewer other
than the author, except for a version bump.</li>
<li>Ensure that security scanning has been completed for this build and
no blocking issue is found.</li>
</ul>
</li>
</ul>
</li>
</ol>
<pre><code class="language-info-attention">Attention
</code></pre>
<pre><code>        The following practices will fail this validation and result in
        manual processing, therefore should be avoided:

        - squashing commits on PR merges
        - commits after PR approval without re-approval

* Details of the analysis are posted to the PRODCM https:&#x26;#x2F;&#x26;#x2F;tidepool.atlassian.net ticket.

* When all the required checks pass validation, the bot recommends approval.
  The cm-bot may be configured to automatically approve the ticket if all of
  the required conditions above (and future ones) are met.  Additionally,
  a manual review / approval is always required in the following conditions:

    - This is the first prod deploy with no prior approval history
    - A related CM ticket / deploy of the same project is pending

* If human approvals are needed, the required approvers will review the
  details and approve/decline accordingly.

* Random inspections of automatically approved tickets are performed by the
  security team monthly to ensure the automation functions properly.
</code></pre>
<pre><code class="language-info-important">Important
</code></pre>
<pre><code>    1. Note that the above flow does not catch weaknesses in design, and
    therefore does not replace the need for threat modeling and security
    review in the design phase.
    2. Additional requirements may be added later as the process continues
    to mature.
</code></pre>
<ol start="3">
<li>
<p><strong>Detect Risky Changes, Deploy and Close</strong></p>
<p>circle-ci.org job proceeds only with an approved and validated PRODCM ticket.</p>
<ul>
<li>
<p>During production deploys, a <code>terraform plan</code> is always performed first to
detect risky changes.</p>
</li>
<li>
<p>Examples of security-related or risky changes include:</p>
<ul>
<li>Change to "policy" attribute of resource (aws_s3_bucket.policy, aws_kms_key.policy)</li>
<li>Change to IAM policy, role, user or group</li>
<li>Attach/detach policy</li>
<li>Change/delete to security group</li>
<li>Anything is deleted (in prod, deletes should be unusual so they should be manually reviewed)</li>
</ul>
</li>
<li>
<p>If risky changes are detected, the deploy is paused and the PRODCM ticket
is updated to require manual review before continuing.</p>
</li>
<li>
<p>Once a deploy is completed, the PRODCM ticket is automatically resolved
and closed.</p>
</li>
</ul>
</li>
</ol>